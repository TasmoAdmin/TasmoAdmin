$(document).on("ready",function(){$(".svg-inject").svgInject(function(){});updateAllStatus()});function updateAllStatus(){var device_holder=$("#device_details");if(!device_holder.hasClass("updating")){device_holder.addClass("updating");console.log("[Devices][updateAllStatus]START");var timeout=device_holder.find("card").length*15;Sonoff.getAllStatus(timeout,function(result){device_holder.find(".card").each(function(key,card){var device_id=$(card).data("device_id");var device_relais=$(card).data("device_relais");var device_group=$(card).data("device_group");var data=result[device_id]||undefined;if(data!==undefined&&!$.isEmptyObject(data)&&!data.ERROR&&!data.WARNING&&data!==""&&data!==undefined&&data.statusText===undefined){console.log("[LIST][updateAllStatus]["+device_id+"]MSG => "+JSON.stringify(data));var device_status=data.StatusSTS.POWER||eval("data.StatusSTS.POWER"+device_relais);updateCard($(card),data,device_status)}else{console.log("[LIST][updateAllStatus]["+device_id+"][ERROR] DATA => "+JSON.stringify(data));if($(card).hasClass("toggled")){$(card).removeClass("toggled")}else{$(card).find(".status").find("input").parent().addClass("error")}var msg=$.i18n("ERROR");if(data!==undefined){if(data.ERROR!==undefined){msg=data.ERROR}else if(data.WARNING!==undefined){msg=data.WARNING}else if(data.statusText!==undefined){msg=data.statusText}}else{msg="data is empty"}$(card).attr("data-original-title",msg).attr("data-toggle","tooltip").tooltip({html:true,delay:700})}});device_holder.removeClass("updating")})}else{console.log("[Devices][updateAllStatus]SKIP")}}function updateCard(card,data,device_status){var version=parseVersion(data.StatusFWR.Version);if(version>=510009){var rssi=data.StatusSTS.Wifi.RSSI;var ssid=data.StatusSTS.Wifi.SSId;var uptime=data.StatusSTS.Uptime}else{var rssi=data.StatusSTS.WLAN?data.StatusSTS.WLAN.RSSI:data.StatusSTS.Wifi.RSSI;var ssid=data.StatusSTS.WLAN?data.StatusSTS.WLAN.SSID:data.StatusSTS.Wifi.SSId;var uptime=data.StatusSTS.Laufzeit?data.StatusSTS.Laufzeit:data.StatusSTS.Uptime}var energyPower=getEnergyPower(data);if(energyPower!=""){$(card).find(".energyPower span").html(energyPower);$("#device-list .energyPower").removeClass("hidden")}var temp=getTemp(data);if(temp!=""){$(card).find(".temp span").html(temp);$("#device-list .temp").removeClass("hidden")}var humidity=getHumidity(data);if(humidity!=""){$(card).find(".humidity span").html(humidity);$("#device-list .humidity").removeClass("hidden")}var pressure=getPressure(data);if(pressure!=""){$(card).find(".pressure span").html(pressure);$("#device-list .pressure").removeClass("hidden")}var distance=getDistance(data);if(distance!=""){$(card).find(".distance span").html(distance);$("#device-list .distance").removeClass("hidden")}var gas=getGas(data);if(gas!=""){$(card).find(".gas span").html(gas);$("#device-list .gas").removeClass("hidden")}var idx=data.idx?data.idx:"";if(idx!=""){$(card).find(".idx span").html(idx);$("#device-list .idx").removeClass("hidden").show()}$(card).find(".version span").html(data.StatusFWR.Version);if($(card).hasClass("toggled")){$(card).removeClass("toggled")}else{if(device_status=="ON"){$(card).find(".status").find("input").prop("checked","checked").parent().removeClass("error")}else{$(card).find(".status").find("input").removeProp("checked").parent().removeClass("error")}}var signalStrength="bad";if(rssi>=25){signalStrength="weak"}if(rssi>=50){signalStrength="medium"}if(rssi>=75){signalStrength="strong"}$(card).find(".device-rssi svg").addClass("ta-wifi-"+signalStrength).removeClass("searching error");var startup=data.StatusPRM.StartupDateTimeUtc!==undefined?data.StatusPRM.StartupDateTimeUtc:data.StatusPRM.StartupUTC!==undefined?data.StatusPRM.StartupUTC:"";if(startup!==""){var startupdatetime=startup+"Z".replace(/-/g,"/");startupdatetime=new Date(startupdatetime);var now=new Date;var sec_num=(now-startupdatetime)/1e3;var days=Math.floor(sec_num/(3600*24));var hours=Math.floor((sec_num-days*(3600*24))/3600);var minutes=Math.floor((sec_num-days*(3600*24)-hours*3600)/60);var seconds=Math.floor(sec_num-days*(3600*24)-hours*3600-minutes*60);uptime=(days!==0?days+$.i18n("UPTIME_SHORT_DAY"):"")+" "+(hours!==0||days!==0?hours+$.i18n("UPTIME_SHORT_HOUR"):"")+" "+(minutes!==0||hours!==0||days!==0?minutes+$.i18n("UPTIME_SHORT_MIN"):"")+" "+(seconds!==0||minutes!==0||hours!==0?seconds+$.i18n("UPTIME_SHORT_SEC"):"-");uptime=$.trim(uptime);$(card).find(".runtime span").html(uptime).attr("data-original-title",startupdatetime.toLocaleString($("html").attr("lang")+"-"+$("html").attr("lang").toUpperCase(),{hour12:false})).attr("data-toggle","tooltip").tooltip({html:true,delay:700})}else{console.log(uptime);$(card).find(".runtime span").html(uptime+"h")}if(!$(card).find(".hostname span").hasClass("dont-update")){$(card).find(".hostname span").html(data.StatusNET.Hostname!==undefined?data.StatusNET.Hostname:"?")}if(!$(card).find(".mac span").hasClass("dont-update")){$(card).find(".mac span").html(data.StatusNET.Mac!==undefined?data.StatusNET.Mac:"?")}if(!$(card).find(".mqtt span").hasClass("dont-update")){$(card).find(".mqtt span").html(data.StatusMQT!==undefined?"1":"0")}if(!$(card).find(".poweronstate span").hasClass("dont-update")){$(card).find(".poweronstate span").html(data.Status.PowerOnState!==undefined?data.Status.PowerOnState:"?")}if(!$(card).find(".ledstate span").hasClass("dont-update")){$(card).find(".ledstate span").html(data.Status.LedState!==undefined?data.Status.LedState:"?")}if(!$(card).find(".savedata span").hasClass("dont-update")){$(card).find(".savedata span").html(data.Status.SaveData!==undefined?data.Status.SaveData:"?")}if(!$(card).find(".sleep span").hasClass("dont-update")){$(card).find(".sleep span").html(data.StatusPRM.Sleep!==undefined?data.StatusPRM.Sleep+"ms":"?")}$(card).find(".bootcount span").html(data.StatusPRM.BootCount!==undefined?data.StatusPRM.BootCount:"?");$(card).find(".savecount span").html(data.StatusPRM.SaveCount!==undefined?data.StatusPRM.SaveCount:"?");$(card).find(".log span").html((data.StatusLOG.SerialLog!==undefined?data.StatusLOG.SerialLog:"?")+"|"+(data.StatusLOG.WebLog!==undefined?data.StatusLOG.WebLog:"?")+"|"+(data.StatusLOG.SysLog!==undefined?data.StatusLOG.SysLog:"?"));if(!$(card).find(".wificonfig span").hasClass("dont-update")){$(card).find(".wificonfig span").html(data.StatusNET.WifiConfig!==undefined?data.StatusNET.WifiConfig:"?")}$(card).find(".vcc span").html(data.StatusSTS.Vcc!==undefined?data.StatusSTS.Vcc+"V":"?");$(".doubleScroll-scroll").css({width:$("#device-list").width()}).parent().trigger("resize");$(card).removeClass("updating")}